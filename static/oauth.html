<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub íŒŒì¼ ì—ë””í„° (PAT)</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="password"], select, textarea {
            width: calc(100% - 22px); /* Adjust for padding */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        textarea { height: 300px; font-family: monospace; }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #fileList ul { list-style: none; padding: 0; }
        #fileList li { padding: 5px 0; border-bottom: 1px solid #eee; cursor: pointer; }
        #fileList li:hover { background-color: #f0f0f0; }
        #fileList li.dir::before { content: 'ğŸ“ '; }
        #fileList li.file::before { content: 'ğŸ“„ '; }
        #statusBar { margin-top: 15px; color: #555; font-style: italic; }
        .hidden { display: none; }
        .error { color: red; font-weight: bold; }
        .breadcrumb a { text-decoration: none; color: #007bff; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb span { margin: 0 5px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <h1>GitHub íŒŒì¼ ì—ë””í„° (PAT ì‚¬ìš©)</h1>

    <!-- 1. Login Section -->
    <div id="loginSection" class="section">
        <h2>1. GitHub ë¡œê·¸ì¸</h2>
        <p class="error"><strong>ê²½ê³ :</strong> Personal Access Tokenì„ ë¸Œë¼ìš°ì €ì— ì…ë ¥í•˜ëŠ” ê²ƒì€ ë³´ì•ˆìƒ ìœ„í—˜í•©ë‹ˆë‹¤. ê°œì¸ì ì¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•˜ê³  í† í° ê´€ë¦¬ì— ìœ ì˜í•˜ì„¸ìš”.</p>
        <label for="patInput">Personal Access Token (PAT):</label>
        <input type="password" id="patInput" placeholder="repo ê¶Œí•œì´ ìˆëŠ” PAT ì…ë ¥">
        <button id="loginButton">ì €ì¥ì†Œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <!-- 2. Repository Selection -->
    <div id="repoSection" class="section hidden">
        <h2>2. ì €ì¥ì†Œ ì„ íƒ</h2>
        <label for="repoSelect">ì €ì¥ì†Œ:</label>
        <select id="repoSelect"></select>
        <button id="loadRepoButton" disabled>íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <!-- 3. File Browser -->
    <div id="fileBrowserSection" class="section hidden">
        <h2>3. íŒŒì¼ íƒìƒ‰ê¸°</h2>
        <div><strong>í˜„ì¬ ì €ì¥ì†Œ:</strong> <span id="currentRepo"></span></div>
        <div class="breadcrumb"><strong>ê²½ë¡œ:</strong> <span id="currentPathBreadcrumb">/</span></div>
        <div id="fileList">
            <ul></ul>
        </div>
        <button id="createNewFileButton">ìƒˆ íŒŒì¼ ë§Œë“¤ê¸°</button>
    </div>

    <!-- 4. File Editor -->
    <div id="editorSection" class="section hidden">
        <h2>4. íŒŒì¼ í¸ì§‘ê¸°</h2>
        <input type="hidden" id="currentFileSha">
        <input type="hidden" id="currentFilePathInput">

        <label for="fileNameInput">íŒŒì¼ ê²½ë¡œ (í˜„ì¬ í´ë” ê¸°ì¤€):</label>
        <input type="text" id="fileNameInput" placeholder="ì˜ˆ: new-file.md">

        <label for="fileContentInput">íŒŒì¼ ë‚´ìš©:</label>
        <textarea id="fileContentInput"></textarea>

        <label for="commitMessageInput">ì»¤ë°‹ ë©”ì‹œì§€:</label>
        <input type="text" id="commitMessageInput" placeholder="ì˜ˆ: íŒŒì¼ ìƒì„± ë˜ëŠ” ìˆ˜ì •">

        <button id="saveFileButton">ì €ì¥ (ìƒì„±/ìˆ˜ì •)</button>
        <button id="deleteFileButton">ì‚­ì œ</button>
        <button id="cancelEditButton">ì·¨ì†Œ</button>
    </div>

    <!-- Status Bar -->
    <div id="statusBar">ìƒíƒœ: ëŒ€ê¸° ì¤‘...</div>

</div>

<script>
    const GITHUB_API_BASE = 'https://api.github.com';
    let githubToken = null;
    let selectedOwner = null;
    let selectedRepo = null;
    let currentPath = ''; // í˜„ì¬ íƒìƒ‰ ì¤‘ì¸ ê²½ë¡œ
    let currentFiles = []; // í˜„ì¬ ê²½ë¡œì˜ íŒŒì¼/í´ë” ëª©ë¡ ìºì‹œ

    // --- DOM Elements ---
    const patInput = document.getElementById('patInput');
    const loginButton = document.getElementById('loginButton');
    const repoSelect = document.getElementById('repoSelect');
    const loadRepoButton = document.getElementById('loadRepoButton');
    const fileListUl = document.querySelector('#fileList ul');
    const currentRepoSpan = document.getElementById('currentRepo');
    const currentPathBreadcrumb = document.getElementById('currentPathBreadcrumb');
    const fileNameInput = document.getElementById('fileNameInput');
    const fileContentInput = document.getElementById('fileContentInput');
    const commitMessageInput = document.getElementById('commitMessageInput');
    const currentFileShaInput = document.getElementById('currentFileSha');
    const currentFilePathInput = document.getElementById('currentFilePathInput');
    const saveFileButton = document.getElementById('saveFileButton');
    const deleteFileButton = document.getElementById('deleteFileButton');
    const cancelEditButton = document.getElementById('cancelEditButton');
    const createNewFileButton = document.getElementById('createNewFileButton');
    const statusBar = document.getElementById('statusBar');

    // --- Sections ---
    const loginSection = document.getElementById('loginSection');
    const repoSection = document.getElementById('repoSection');
    const fileBrowserSection = document.getElementById('fileBrowserSection');
    const editorSection = document.getElementById('editorSection');

    // --- Helper Functions ---
    function updateStatus(message, isError = false) {
        statusBar.textContent = `ìƒíƒœ: ${message}`;
        statusBar.className = isError ? 'error' : '';
        console.log(message);
    }

    function showSection(sectionToShow) {
        [loginSection, repoSection, fileBrowserSection, editorSection].forEach(section => {
            section.classList.add('hidden');
        });
        if (sectionToShow) {
            sectionToShow.classList.remove('hidden');
        }
    }

    async function githubApiRequest(endpoint, options = {}) {
        if (!githubToken) {
            throw new Error('GitHub PATê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        const url = endpoint.startsWith('http') ? endpoint : `${GITHUB_API_BASE}${endpoint}`;
        const headers = {
            'Authorization': `Bearer ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            ...options.headers,
        };

        // POST, PUT, DELETE ìš”ì²­ ì‹œ Content-Type ì„¤ì •
        if (options.method && ['POST', 'PUT', 'DELETE'].includes(options.method.toUpperCase()) && options.body) {
            headers['Content-Type'] = 'application/json';
        }

        updateStatus('GitHub API ìš”ì²­ ì¤‘...');
        try {
            const response = await fetch(url, { ...options, headers });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' }));
                throw new Error(`GitHub API ì˜¤ë¥˜ (${response.status}): ${errorData.message || response.statusText}`);
            }
             // DELETE ìš”ì²­ì€ ë‚´ìš©ì´ ì—†ì„ ìˆ˜ ìˆìŒ
            if (response.status === 204 || response.headers.get('Content-Length') === '0') {
                 updateStatus('GitHub API ìš”ì²­ ì„±ê³µ.');
                 return null; // No content
            }
            const data = await response.json();
            updateStatus('GitHub API ìš”ì²­ ì„±ê³µ.');
            return data;
        } catch (error) {
            updateStatus(`ì˜¤ë¥˜: ${error.message}`, true);
            throw error; // Re-throw for further handling
        }
    }

    // Base64 ì¸ì½”ë”©/ë””ì½”ë”© (UTF-8 ì§€ì›)
    function b64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
            return String.fromCharCode('0x' + p1);
        }));
    }

    function b64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    }

    // ê²½ë¡œ Breadcrumb ìƒì„±
    function updateBreadcrumb() {
        currentPathBreadcrumb.innerHTML = ''; // Clear existing
        const pathParts = currentPath.split('/').filter(p => p); // ë¹ˆ ìš”ì†Œ ì œê±°
        const rootLink = document.createElement('a');
        rootLink.href = '#';
        rootLink.textContent = '/';
        rootLink.onclick = (e) => { e.preventDefault(); fetchContents(''); };
        currentPathBreadcrumb.appendChild(rootLink);

        let accumulatedPath = '';
        pathParts.forEach((part, index) => {
            accumulatedPath += (accumulatedPath ? '/' : '') + part;
            const pathSpan = document.createElement('span');
            pathSpan.textContent = '>';
            currentPathBreadcrumb.appendChild(pathSpan);

            const partLink = document.createElement('a');
            partLink.href = '#';
            partLink.textContent = part;
            // í´ë¡œì €ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¬ë°”ë¥¸ ê²½ë¡œ ì „ë‹¬
            const currentAccumulatedPath = accumulatedPath;
            partLink.onclick = (e) => { e.preventDefault(); fetchContents(currentAccumulatedPath); };
            currentPathBreadcrumb.appendChild(partLink);
        });
         // ë§ˆì§€ë§‰ì— ìŠ¬ë˜ì‹œ ì¶”ê°€ (ë£¨íŠ¸ê°€ ì•„ë‹ ê²½ìš°)
        if (currentPath) {
             const trailingSlash = document.createElement('span');
             trailingSlash.textContent = '/';
             currentPathBreadcrumb.appendChild(trailingSlash);
        }
    }


    // --- Event Handlers ---

    // 1. Login
    loginButton.addEventListener('click', async () => {
        githubToken = patInput.value.trim();
        if (!githubToken) {
            updateStatus('PATë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', true);
            return;
        }
        patInput.disabled = true;
        loginButton.disabled = true;
        updateStatus('ì €ì¥ì†Œ ëª©ë¡ ë¡œë”© ì¤‘...');
        try {
            // /user/repos ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìì˜ ëª¨ë“  ì €ì¥ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            // í˜ì´ì§€ë„¤ì´ì…˜ì„ ê³ ë ¤í•˜ì—¬ ìµœëŒ€ 100ê°œê¹Œì§€ ìš”ì²­ (í•„ìš”ì‹œ ë°˜ë³µ ìš”ì²­ êµ¬í˜„)
            const repos = await githubApiRequest('/user/repos?per_page=100&sort=updated');
            repoSelect.innerHTML = '<option value="">-- ì €ì¥ì†Œ ì„ íƒ --</option>'; // Clear previous options
            repos.forEach(repo => {
                const option = document.createElement('option');
                option.value = `${repo.owner.login}/${repo.name}`;
                option.textContent = repo.full_name;
                repoSelect.appendChild(option);
            });
            updateStatus('ì €ì¥ì†Œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ.');
            showSection(repoSection);
            loadRepoButton.disabled = false;
            repoSection.classList.remove('hidden'); // Show repo section
        } catch (error) {
            updateStatus(`ì €ì¥ì†Œ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: ${error.message}`, true);
            patInput.disabled = false;
            loginButton.disabled = false;
        }
    });

    // 2. Repository Selection
    repoSelect.addEventListener('change', () => {
        loadRepoButton.disabled = repoSelect.value === '';
    });

    loadRepoButton.addEventListener('click', () => {
        const selectedRepoFullName = repoSelect.value;
        if (!selectedRepoFullName) return;

        [selectedOwner, selectedRepo] = selectedRepoFullName.split('/');
        currentRepoSpan.textContent = selectedRepoFullName;
        updateStatus(`'${selectedRepoFullName}' ì €ì¥ì†Œ íŒŒì¼ ëª©ë¡ ë¡œë”©...`);
        showSection(fileBrowserSection); // Show file browser
        fetchContents(''); // Load root directory
    });

    // 3. Fetch Repository Contents (Files/Folders)
    async function fetchContents(path) {
        currentPath = path;
        updateBreadcrumb(); // Update breadcrumb based on the new path
        fileListUl.innerHTML = ''; // Clear previous list
        updateStatus(`'${selectedOwner}/${selectedRepo}/${path}' ë¡œë”© ì¤‘...`);
        showSection(fileBrowserSection); // Make sure browser is visible

        try {
            const contents = await githubApiRequest(`/repos/${selectedOwner}/${selectedRepo}/contents/${path}`);
            currentFiles = contents.sort((a, b) => { // Sort: folders first, then by name
                if (a.type === b.type) {
                    return a.name.localeCompare(b.name);
                }
                return a.type === 'dir' ? -1 : 1;
            });

            // Add '..' (Up directory) link if not in root
            if (path !== '') {
                const parentPath = path.substring(0, path.lastIndexOf('/'));
                const li = document.createElement('li');
                li.textContent = 'â¬†ï¸ .. (ìƒìœ„ í´ë”)';
                li.style.cursor = 'pointer';
                li.style.fontWeight = 'bold';
                li.onclick = () => fetchContents(parentPath);
                fileListUl.appendChild(li);
            }

            // Populate file/directory list
            currentFiles.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name;
                li.classList.add(item.type); // Add 'dir' or 'file' class
                li.dataset.path = item.path;
                li.dataset.type = item.type;
                li.dataset.sha = item.sha; // Store sha for later use (especially for files)

                if (item.type === 'dir') {
                    li.onclick = () => fetchContents(item.path);
                } else if (item.type === 'file') {
                    li.onclick = () => fetchFileContent(item.path, item.sha);
                }
                fileListUl.appendChild(li);
            });
             updateStatus(`'${selectedOwner}/${selectedRepo}/${path}' ë¡œë“œ ì™„ë£Œ.`);
        } catch (error) {
            updateStatus(`íŒŒì¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨ (${path}): ${error.message}`, true);
            // Optionally show the browser section even on error to allow navigation back
            showSection(fileBrowserSection);
        }
    }

    // 4. Fetch File Content
    async function fetchFileContent(filePath, fileSha) {
        updateStatus(`'${filePath}' íŒŒì¼ ë‚´ìš© ë¡œë”© ì¤‘...`);
        try {
            const fileData = await githubApiRequest(`/repos/${selectedOwner}/${selectedRepo}/contents/${filePath}`);

            if (fileData.encoding !== 'base64') {
                throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì¸ì½”ë”©ì…ë‹ˆë‹¤: ' + fileData.encoding);
            }
            if (fileData.content === undefined || fileData.sha === undefined) {
                 throw new Error('API ì‘ë‹µì— content ë˜ëŠ” shaê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            const decodedContent = b64DecodeUnicode(fileData.content);

            // Populate editor
            fileNameInput.value = filePath.substring(filePath.lastIndexOf('/') + 1); // Extract filename
            fileContentInput.value = decodedContent;
            commitMessageInput.value = `Update ${fileNameInput.value}`; // Default commit message
            currentFileShaInput.value = fileData.sha; // Store SHA for update/delete
            currentFilePathInput.value = filePath; // Store full path

            // Enable/disable delete button based on whether it's an existing file
            deleteFileButton.disabled = false;
            saveFileButton.textContent = 'ì €ì¥ (ìˆ˜ì •)';

            updateStatus(`'${filePath}' ë¡œë“œ ì™„ë£Œ.`);
            showSection(editorSection); // Show editor

        } catch (error) {
            updateStatus(`íŒŒì¼ ë‚´ìš© ë¡œë”© ì‹¤íŒ¨ (${filePath}): ${error.message}`, true);
            showSection(fileBrowserSection); // Go back to browser on error
        }
    }

    // 5. Show Create New File Form
    createNewFileButton.addEventListener('click', () => {
        fileNameInput.value = '';
        fileContentInput.value = '';
        commitMessageInput.value = 'Create new file';
        currentFileShaInput.value = ''; // No SHA for new file
        currentFilePathInput.value = ''; // Path will be constructed on save

        deleteFileButton.disabled = true; // Cannot delete a new file
        saveFileButton.textContent = 'ì €ì¥ (ìƒì„±)';

        updateStatus('ìƒˆ íŒŒì¼ ìƒì„± ì¤€ë¹„ ì™„ë£Œ.');
        showSection(editorSection);
        fileNameInput.focus();
    });


    // 6. Save File (Create or Update)
    saveFileButton.addEventListener('click', async () => {
        const fileName = fileNameInput.value.trim();
        const fileContent = fileContentInput.value;
        let commitMessage = commitMessageInput.value.trim();
        const existingSha = currentFileShaInput.value; // SHA for updates
        const isUpdate = !!existingSha;

        if (!fileName) {
            updateStatus('íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', true);
            return;
        }
        if (!commitMessage) {
            commitMessage = isUpdate ? `Update ${fileName}` : `Create ${fileName}`;
        }

        // Construct the full path relative to the current directory
        const fullPath = (currentPath ? currentPath + '/' : '') + fileName;

        updateStatus(`'${fullPath}' ì €ì¥ ì¤‘...`);
        saveFileButton.disabled = true;
        cancelEditButton.disabled = true;
        deleteFileButton.disabled = true;

        try {
            const encodedContent = b64EncodeUnicode(fileContent);
            const body = {
                message: commitMessage,
                content: encodedContent,
                branch: null // Use default branch (TODO: Add branch selection)
            };

            // Add SHA only if updating an existing file
            if (isUpdate) {
                 // Verify the path hasn't changed unexpectedly during editing
                 if (fullPath !== currentFilePathInput.value) {
                      throw new Error("íŒŒì¼ ê²½ë¡œê°€ í¸ì§‘ ì¤‘ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì •ì„ ì·¨ì†Œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
                 }
                body.sha = existingSha;
            }

            await githubApiRequest(`/repos/${selectedOwner}/${selectedRepo}/contents/${fullPath}`, {
                method: 'PUT',
                body: JSON.stringify(body)
            });

            updateStatus(`'${fullPath}' ${isUpdate ? 'ìˆ˜ì •' : 'ìƒì„±'} ì™„ë£Œ.`);
            // Go back to the file browser and refresh the current directory
            fetchContents(currentPath);

        } catch (error) {
            updateStatus(`íŒŒì¼ ì €ì¥ ì‹¤íŒ¨ (${fullPath}): ${error.message}`, true);
        } finally {
            saveFileButton.disabled = false;
            cancelEditButton.disabled = false;
             // Re-enable delete only if it was an update initially
            deleteFileButton.disabled = !isUpdate;
            // Don't automatically hide editor on failure, let user retry/cancel
        }
    });

    // 7. Delete File
    deleteFileButton.addEventListener('click', async () => {
        const filePathToDelete = currentFilePathInput.value;
        const fileShaToDelete = currentFileShaInput.value;

        if (!filePathToDelete || !fileShaToDelete) {
            updateStatus('ì‚­ì œí•  íŒŒì¼ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', true);
            return;
        }

        if (!confirm(`ì •ë§ë¡œ '${filePathToDelete}' íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            return;
        }

        let commitMessage = commitMessageInput.value.trim();
         if (!commitMessage || !commitMessage.toLowerCase().includes('delete') ) {
             commitMessage = `Delete ${filePathToDelete}`;
         }


        updateStatus(`'${filePathToDelete}' ì‚­ì œ ì¤‘...`);
        saveFileButton.disabled = true;
        cancelEditButton.disabled = true;
        deleteFileButton.disabled = true;

        try {
            await githubApiRequest(`/repos/${selectedOwner}/${selectedRepo}/contents/${filePathToDelete}`, {
                method: 'DELETE',
                body: JSON.stringify({
                    message: commitMessage,
                    sha: fileShaToDelete,
                    branch: null // Use default branch
                })
            });

            updateStatus(`'${filePathToDelete}' ì‚­ì œ ì™„ë£Œ.`);
            // Go back to the file browser and refresh the current directory
            fetchContents(currentPath);

        } catch (error) {
            updateStatus(`íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨ (${filePathToDelete}): ${error.message}`, true);
             // Re-enable buttons on failure
            saveFileButton.disabled = false;
            cancelEditButton.disabled = false;
            deleteFileButton.disabled = false;
        }
        // No finally needed here as success navigates away
    });

    // 8. Cancel Edit
    cancelEditButton.addEventListener('click', () => {
        updateStatus('í¸ì§‘ ì·¨ì†Œë¨.');
        // Just show the file browser, don't necessarily reload it
        showSection(fileBrowserSection);
        // Clear editor state (optional, but good practice)
        fileNameInput.value = '';
        fileContentInput.value = '';
        commitMessageInput.value = '';
        currentFileShaInput.value = '';
        currentFilePathInput.value = '';
    });


    // --- Initial State ---
    showSection(loginSection); // Start with login section
    updateStatus('ì‹œì‘: GitHub PATë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

</script>

</body>
</html>