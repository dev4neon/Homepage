<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub íŒŒì¼ ê´€ë¦¬ì</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .sidebar {
            flex: 1;
            border-right: 1px solid #e1e4e8;
            padding-right: 20px;
        }
        .content {
            flex: 3;
        }
        button {
            background-color: #2da44e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 0;
        }
        button:hover {
            background-color: #2c974b;
        }
        button.secondary {
            background-color: #6e7781;
        }
        button.secondary:hover {
            background-color: #57606a;
        }
        button.danger {
            background-color: #cf222e;
        }
        button.danger:hover {
            background-color: #a40e26;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 300px;
            font-family: monospace;
        }
        .repo-list {
            list-style: none;
            padding: 0;
        }
        .repo-list li {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            cursor: pointer;
        }
        .repo-list li:hover {
            background-color: #f6f8fa;
        }
        .file-list {
            list-style: none;
            padding: 0;
        }
        .file-list li {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .file-list li:hover {
            background-color: #f6f8fa;
        }
        .hidden {
            display: none;
        }
        #login-section {
            text-align: center;
            margin: 50px auto;
            max-width: 500px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e4e8;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info img {
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="login-section">
        <h1>GitHub íŒŒì¼ ê´€ë¦¬ì</h1>
        <p>GitHub ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ ë ˆí¬ì§€í† ë¦¬ íŒŒì¼ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
        <button id="login-btn">GitHubë¡œ ë¡œê·¸ì¸</button>
    </div>

    <div id="app" class="hidden">
        <div class="header">
            <h1>GitHub íŒŒì¼ ê´€ë¦¬ì</h1>
            <div class="user-info">
                <img id="user-avatar" width="32" height="32" alt="User avatar">
                <span id="user-name"></span>
                <button id="logout-btn" class="secondary">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="container">
            <div class="sidebar">
                <h2>ë ˆí¬ì§€í† ë¦¬</h2>
                <select id="repo-visibility">
                    <option value="all">ëª¨ë“  ë ˆí¬ì§€í† ë¦¬</option>
                    <option value="public">ê³µê°œ ë ˆí¬ì§€í† ë¦¬</option>
                    <option value="private">ë¹„ê³µê°œ ë ˆí¬ì§€í† ë¦¬</option>
                </select>
                <ul id="repo-list" class="repo-list"></ul>
            </div>

            <div class="content">
                <div id="repo-content" class="hidden">
                    <h2 id="current-repo"></h2>
                    <div id="path-nav"></div>
                    <button id="new-file-btn">ìƒˆ íŒŒì¼ ìƒì„±</button>
                    <ul id="file-list" class="file-list"></ul>
                </div>

                <div id="file-editor" class="hidden">
                    <h2>íŒŒì¼ í¸ì§‘</h2>
                    <p id="file-path"></p>
                    <input type="text" id="file-name" placeholder="íŒŒì¼ ì´ë¦„">
                    <textarea id="file-content"></textarea>
                    <div>
                        <input type="text" id="commit-message" placeholder="ì»¤ë°‹ ë©”ì‹œì§€">
                        <button id="save-file-btn">ì €ì¥</button>
                        <button id="cancel-edit-btn" class="secondary">ì·¨ì†Œ</button>
                        <button id="delete-file-btn" class="danger">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GitHub OAuth ì„¤ì •
        const clientId = 'Ov23liAGHXQS0X09MzFR'; // GitHub OAuth Appì˜ Client IDë¡œ ë³€ê²½í•˜ì„¸ìš”
        const redirectUri = 'https://neonsnow.net/oauth';
        const scope = 'repo'; // ë ˆí¬ì§€í† ë¦¬ ì ‘ê·¼ ê¶Œí•œ

        // DOM ìš”ì†Œ
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const repoList = document.getElementById('repo-list');
        const repoVisibility = document.getElementById('repo-visibility');
        const repoContent = document.getElementById('repo-content');
        const currentRepo = document.getElementById('current-repo');
        const pathNav = document.getElementById('path-nav');
        const fileList = document.getElementById('file-list');
        const fileEditor = document.getElementById('file-editor');
        const filePath = document.getElementById('file-path');
        const fileName = document.getElementById('file-name');
        const fileContent = document.getElementById('file-content');
        const commitMessage = document.getElementById('commit-message');
        const saveFileBtn = document.getElementById('save-file-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const deleteFileBtn = document.getElementById('delete-file-btn');
        const newFileBtn = document.getElementById('new-file-btn');

        // ìƒíƒœ ë³€ìˆ˜
        let accessToken = '';
        let selectedRepo = '';
        let currentPath = '';
        let currentSha = '';
        let isNewFile = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = function() {
            // URLì—ì„œ ì½”ë“œ íŒŒë¼ë¯¸í„° í™•ì¸
            const code = new URLSearchParams(window.location.search).get('code');
            if (code) {
                // ì½”ë“œê°€ ìˆìœ¼ë©´ ì•¡ì„¸ìŠ¤ í† í° ìš”ì²­
                exchangeCodeForToken(code);
            } else {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í† í° í™•ì¸
                const token = localStorage.getItem('github_token');
                if (token) {
                    accessToken = token;
                    showApp();
                    fetchUserInfo();
                    fetchRepositories();
                }
            }
        };

        // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        loginBtn.addEventListener('click', () => {
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;
            window.location.href = authUrl;
        });

        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('github_token');
            window.location.href = redirectUri.split('?')[0];
        });

        // ë ˆí¬ì§€í† ë¦¬ ê°€ì‹œì„± ë³€ê²½ ì´ë²¤íŠ¸
        repoVisibility.addEventListener('change', fetchRepositories);

        // ìƒˆ íŒŒì¼ ìƒì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        newFileBtn.addEventListener('click', () => {
            isNewFile = true;
            showFileEditor();
            fileName.value = '';
            fileContent.value = '';
            filePath.textContent = `${currentPath}`;
            commitMessage.value = 'ìƒˆ íŒŒì¼ ìƒì„±';
            deleteFileBtn.style.display = 'none';
        });

        // íŒŒì¼ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        saveFileBtn.addEventListener('click', saveFile);

        // í¸ì§‘ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        cancelEditBtn.addEventListener('click', () => {
            fileEditor.classList.add('hidden');
            repoContent.classList.remove('hidden');
        });

        // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        deleteFileBtn.addEventListener('click', deleteFile);

        // ì½”ë“œë¥¼ ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ êµí™˜
        function exchangeCodeForToken(code) {
            // ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ì„œë²„ ì¸¡ì—ì„œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
            // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” ê²ƒì€ ë³´ì•ˆìƒ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤.
            // ì´ ì˜ˆì œì—ì„œëŠ” ì„œë²„ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
            
            // ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì½”ë“œë¥¼ ë³´ë‚´ í† í°ì„ ë°›ì•„ì˜µë‹ˆë‹¤.
            fetch('https://your-server-endpoint/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code })
            })
            .then(response => response.json())
            .then(data => {
                accessToken = data.access_token;
                localStorage.setItem('github_token', accessToken);
                
                // URLì—ì„œ ì½”ë“œ íŒŒë¼ë¯¸í„° ì œê±°
                const url = new URL(window.location.href);
                url.searchParams.delete('code');
                window.history.replaceState({}, document.title, url);
                
                showApp();
                fetchUserInfo();
                fetchRepositories();
            })
            .catch(error => {
                console.error('í† í° êµí™˜ ì˜¤ë¥˜:', error);
                alert('GitHub ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function fetchUserInfo() {
            fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                userAvatar.src = data.avatar_url;
                userName.textContent = data.login;
            })
            .catch(error => console.error('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error));
        }

        // ë ˆí¬ì§€í† ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        function fetchRepositories() {
            const visibility = repoVisibility.value;
            let url = 'https://api.github.com/user/repos?sort=updated&direction=desc';
            
            if (visibility !== 'all') {
                url += `&visibility=${visibility}`;
            }
            
            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                repoList.innerHTML = '';
                data.forEach(repo => {
                    const li = document.createElement('li');
                    li.textContent = repo.name;
                    li.dataset.name = repo.name;
                    li.dataset.fullName = repo.full_name;
                    li.addEventListener('click', () => selectRepository(repo.full_name, repo.name));
                    repoList.appendChild(li);
                });
            })
            .catch(error => console.error('ë ˆí¬ì§€í† ë¦¬ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error));
        }

        // ë ˆí¬ì§€í† ë¦¬ ì„ íƒ
        function selectRepository(fullName, name) {
            selectedRepo = fullName;
            currentRepo.textContent = name;
            currentPath = '';
            fetchRepoContents();
            repoContent.classList.remove('hidden');
            fileEditor.classList.add('hidden');
        }

        // ë ˆí¬ì§€í† ë¦¬ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        function fetchRepoContents(path = '') {
            currentPath = path;
            updatePathNavigation();
            
            fetch(`https://api.github.com/repos/${selectedRepo}/contents/${path}`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                fileList.innerHTML = '';
                
                if (Array.isArray(data)) {
                    // ë””ë ‰í† ë¦¬ ë‚´ìš© í‘œì‹œ
                    data.sort((a, b) => {
                        // ë””ë ‰í† ë¦¬ë¥¼ ë¨¼ì € í‘œì‹œ
                        if (a.type === 'dir' && b.type !== 'dir') return -1;
                        if (a.type !== 'dir' && b.type === 'dir') return 1;
                        return a.name.localeCompare(b.name);
                    });
                    
                    data.forEach(item => {
                        const li = document.createElement('li');
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = item.name;
                        
                        li.appendChild(nameSpan);
                        
                        if (item.type === 'dir') {
                            li.addEventListener('click', () => fetchRepoContents(item.path));
                            nameSpan.textContent = `ğŸ“ ${item.name}`;
                        } else {
                            const actions = document.createElement('div');
                            
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'í¸ì§‘';
                            editBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                editFile(item);
                            });
                            
                            actions.appendChild(editBtn);
                            li.appendChild(actions);
                            nameSpan.textContent = `ğŸ“„ ${item.name}`;
                        }
                        
                        fileList.appendChild(li);
                    });
                } else {
                    // ë‹¨ì¼ íŒŒì¼ ë‚´ìš© í‘œì‹œ
                    editFile(data);
                }
            })
            .catch(error => console.error('ë ˆí¬ì§€í† ë¦¬ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error));
        }

        // ê²½ë¡œ ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
        function updatePathNavigation() {
            pathNav.innerHTML = '';
            
            const paths = currentPath.split('/').filter(p => p);
            let currentPathBuild = '';
            
            // ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ë§í¬
            const rootLink = document.createElement('a');
            rootLink.textContent = 'í™ˆ';
            rootLink.href = '#';
            rootLink.addEventListener('click', (e) => {
                e.preventDefault();
                fetchRepoContents('');
            });
            pathNav.appendChild(rootLink);
            
            // ê° ê²½ë¡œ ì„¸ê·¸ë¨¼íŠ¸ì— ëŒ€í•œ ë§í¬
            paths.forEach((path, index) => {
                pathNav.appendChild(document.createTextNode(' / '));
                
                currentPathBuild += (index === 0 ? '' : '/') + path;
                
                const pathLink = document.createElement('a');
                pathLink.textContent = path;
                pathLink.href = '#';
                const pathToFetch = currentPathBuild;
                pathLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    fetchRepoContents(pathToFetch);
                });
                
                pathNav.appendChild(pathLink);
            });
        }

        // íŒŒì¼ í¸ì§‘
        function editFile(file) {
            isNewFile = false;
            showFileEditor();
            
            fileName.value = file.name;
            filePath.textContent = file.path;
            currentSha = file.sha;
            deleteFileBtn.style.display = 'inline-block';
            
            if (file.content) {
                // ì´ë¯¸ ì½˜í…ì¸ ê°€ ìˆëŠ” ê²½ìš°
                const content = atob(file.content);
                fileContent.value = content;
                commitMessage.value = `${file.name} ì—…ë°ì´íŠ¸`;
            } else {
                // ì½˜í…ì¸ ë¥¼ ë³„ë„ë¡œ ê°€ì ¸ì™€ì•¼ í•˜ëŠ” ê²½ìš°
                fetch(file.download_url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                })
                .then(response => response.text())
                .then(content => {
                    fileContent.value = content;
                    commitMessage.value = `${file.name} ì—…ë°ì´íŠ¸`;
                })
                .catch(error => console.error('íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error));
            }
        }

        // íŒŒì¼ ì €ì¥
        function saveFile() {
            const newFileName = fileName.value.trim();
            const content = fileContent.value;
            const message = commitMessage.value.trim() || 'íŒŒì¼ ì—…ë°ì´íŠ¸';
            
            if (!newFileName) {
                alert('íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            let path = currentPath ? `${currentPath}/${newFileName}` : newFileName;
            
            // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ íŒŒì¼ì˜ ê²½ë¡œì—ì„œ íŒŒ
            // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ íŒŒì¼ì˜ ê²½ë¡œì—ì„œ íŒŒì¼ëª…ë§Œ ë³€ê²½í•˜ëŠ” ê²½ìš°
            if (!isNewFile && filePath.textContent.split('/').pop() !== newFileName) {
                path = filePath.textContent.replace(/[^/]+$/, newFileName);
            } else if (!isNewFile) {
                path = filePath.textContent;
            }
            
            // Base64ë¡œ ì¸ì½”ë”©
            const encodedContent = btoa(unescape(encodeURIComponent(content)));
            
            const data = {
                message: message,
                content: encodedContent,
                branch: 'main' // ê¸°ë³¸ ë¸Œëœì¹˜ ì´ë¦„, í•„ìš”ì— ë”°ë¼ ë³€ê²½ ê°€ëŠ¥
            };
            
            // ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸ì¸ ê²½ìš° SHA ì¶”ê°€
            if (!isNewFile) {
                data.sha = currentSha;
            }
            
            fetch(`https://api.github.com/repos/${selectedRepo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜ ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                alert('íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                fileEditor.classList.add('hidden');
                repoContent.classList.remove('hidden');
                fetchRepoContents(currentPath);
            })
            .catch(error => {
                console.error('íŒŒì¼ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        }

        // íŒŒì¼ ì‚­ì œ
        function deleteFile() {
            if (!confirm('ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            const path = filePath.textContent;
            const message = `${path.split('/').pop()} ì‚­ì œ`;
            
            fetch(`https://api.github.com/repos/${selectedRepo}/contents/${path}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    sha: currentSha,
                    branch: 'main' // ê¸°ë³¸ ë¸Œëœì¹˜ ì´ë¦„, í•„ìš”ì— ë”°ë¼ ë³€ê²½ ê°€ëŠ¥
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜ ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                alert('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                fileEditor.classList.add('hidden');
                repoContent.classList.remove('hidden');
                fetchRepoContents(currentPath);
            })
            .catch(error => {
                console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        }

        // ì•± UI í‘œì‹œ
        function showApp() {
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
        }

        // íŒŒì¼ ì—ë””í„° í‘œì‹œ
        function showFileEditor() {
            repoContent.classList.add('hidden');
            fileEditor.classList.remove('hidden');
        }
    </script>
</body>
</html>
